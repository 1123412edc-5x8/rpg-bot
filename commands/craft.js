const { qualities, tiers, parts, weaponTypes } = require('../utils/equipData.js');
const fs = require('fs');

module.exports = {
    name: 'craft',
        aliases: ['ÂêàÊàê', 'hc'], // ÊîØÊè¥ ~ÂêàÊàê Êàñ ~hc
            async execute(message, args, p, players) {
                    // --- 1. ‰∏≠ÊñáËàáÁ∏ÆÂØ´Ë≠òÂà•Á≥ªÁµ± ---
                            const lv = parseInt(args[0]);
                                    const typeInput = args[1];

                                            if (!lv || !typeInput) {
                                                        return message.reply("üí° **Áî®Ê≥ïÔºö**`~ÂêàÊàê [Á≠âÁ¥ö] [È°ûÂûã]`\n‰æãÔºö`~ÂêàÊàê 10 Âºì`„ÄÅ`~ÂêàÊàê 90 È†≠`\n(Á≠âÁ¥öÔºö10, 30, 50, 70, 90)");
                                                                }

                                                                        // ÈÉ®‰ΩçËá™ÂãïË≠òÂà•Êò†Â∞Ñ
                                                                                let part = "";
                                                                                        let type = typeInput;

                                                                                                const weaponList = ['Âäç', 'Âºì', 'Áüõ'];
                                                                                                        const headList = ['È†≠', 'È†≠Áõî', 'È†Ç'];
                                                                                                                const armorList = ['Áî≤', 'Ë≠∑Áî≤', 'Ë°£Êúç', 'Ë∫´'];
                                                                                                                        const bootsList = ['Èûã', 'Èù¥Â≠ê', 'Èù¥', 'Ë∂≥'];

                                                                                                                                if (weaponList.includes(typeInput)) {
                                                                                                                                            part = "weapon";
                                                                                                                                                    } else if (headList.includes(typeInput)) {
                                                                                                                                                                part = "head";
                                                                                                                                                                            type = "È†≠Áõî";
                                                                                                                                                                                    } else if (armorList.includes(typeInput)) {
                                                                                                                                                                                                part = "armor";
                                                                                                                                                                                                            type = "Ë≠∑Áî≤";
                                                                                                                                                                                                                    } else if (bootsList.includes(typeInput)) {
                                                                                                                                                                                                                                part = "boots";
                                                                                                                                                                                                                                            type = "Èù¥Â≠ê";
                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                            if (!part || !tiers[lv]) {
                                                                                                                                                                                                                                                                        return message.reply("‚ùå **Ëæ®Ë≠òÂ§±ÊïóÔºÅ** Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÁöÑÁ≠âÁ¥öËàáÈ°ûÂûã (Âäç/Âºì/Áüõ/È†≠/Áî≤/Èûã)„ÄÇ");
                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                        const tier = tiers[lv];
                                                                                                                                                                                                                                                                                                const recipeCost = lv * 100;

                                                                                                                                                                                                                                                                                                        // --- 2. Ê¢ù‰ª∂Ê™¢Êü• (ÊùêÊñô„ÄÅÈáëÂπ£„ÄÅÁ≠âÁ¥ö) ---
                                                                                                                                                                                                                                                                                                                if (p.level < lv) return message.reply(`‚ùå **Á≠âÁ¥ö‰∏çË∂≥ÔºÅ** ‰Ω†ÈúÄË¶Å Lv.${lv} ÊâçËÉΩË£Ω‰ΩúÈÄôÈöéË£ùÂÇô„ÄÇ`);
                                                                                                                                                                                                                                                                                                                        if (p.money < recipeCost) return message.reply(`‚ùå **ÈáëÂπ£‰∏çË∂≥ÔºÅ** ÂêàÊàêÈúÄË¶Å \`$${recipeCost}\`„ÄÇ`);
                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                        const hasMain = p.inventory[tier.material] || 0;
                                                                                                                                                                                                                                                                                                                                                const hasSub = p.inventory[tier.sub] || 0;
                                                                                                                                                                                                                                                                                                                                                        if (hasMain < 10 || hasSub < 5) {
                                                                                                                                                                                                                                                                                                                                                                    return message.reply(`‚ùå **ÊùêÊñô‰∏çË∂≥ÔºÅ** ÈúÄË¶ÅÔºö\nüì¶ 10x \`${tier.material}\` (‰Ω†Êúâ: ${hasMain})\nüì¶ 5x \`${tier.sub}\` (‰Ω†Êúâ: ${hasSub})`);
                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                    // --- 3. Èö®Ê©üÊ±∫ÂÆöÂìÅË≥™ (Ë≥≠ÁãóÊôÇÂàªÔºÅ) ---
                                                                                                                                                                                                                                                                                                                                                                                            const roll = Math.random() * 100;
                                                                                                                                                                                                                                                                                                                                                                                                    let finalQual = "White";
                                                                                                                                                                                                                                                                                                                                                                                                            let accum = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                    for (const [q, info] of Object.entries(qualities)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                accum += info.chance;
                                                                                                                                                                                                                                                                                                                                                                                                                                            if (roll <= accum) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            finalQual = q;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // --- 4. Ë®àÁÆóÂ±¨ÊÄß ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const baseValue = lv * 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const qMult = qualities[finalQual].mult;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const pWeight = parts[part].weight;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let finalStat = Math.floor(baseValue * qMult * pWeight);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Ê≠¶Âô®È°ûÂûãÈ°çÂ§ñ‰øÆÊ≠£
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let weaponLabel = "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (part === "weapon") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const wType = weaponTypes[type] || weaponTypes["Âäç"];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        finalStat = Math.floor(finalStat * wType.atkBonus);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    weaponLabel = type;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // --- 5. Êâ£Èô§ËàáÁôºÊîæ ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p.money -= recipeCost;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    p.inventory[tier.material] -= 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p.inventory[tier.sub] -= 5;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const itemName = `${qualities[finalQual].label} ${tier.name}${weaponLabel || parts[part].name}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ÂàùÂßãÂåñË®≠ÂÇôÊßΩ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    p.equipment = p.equipment || {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p.equipment.plus = p.equipment.plus || {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p.equipment[part] = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: itemName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    stat: finalStat,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                quality: finalQual,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            plus: 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // --- 6. Â≠òÊ™î ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    players[message.author.id] = p;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fs.writeFileSync('./players.json', JSON.stringify(players, null, 2));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return message.reply(`‚öíÔ∏è **ÊâìÈÄ†ÊàêÂäüÔºÅ**\n‰Ω†Áç≤Âæó‰∫ÜÔºö**${itemName}**\nüîπ Âü∫Á§éÂ±¨ÊÄßÔºö\`+${finalStat}\` ${parts[part].mainStat.toUpperCase()}\nüí∞ ÂêàÊàêËä±Ë≤ªÔºö\`$${recipeCost}\``);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };